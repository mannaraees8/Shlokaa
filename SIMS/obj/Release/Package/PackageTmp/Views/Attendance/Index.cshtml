@using PagedList;
@using PagedList.Mvc
@model  IPagedList<SIMS.Models.AttendanceModel>

@{
    ViewBag.Title = "Attendance";
    Layout = "~/Views/Shared/_AdminLayoutPage.cshtml";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />


<style>
    @@media (max-width:670px) {
        .admin-outer-form {
            padding: 0;
        }

        .admin-form {
            padding: 20px;
        }
    }

    input::-webkit-calendar-picker-indicator {
        display: none;
    }

    input[type="time"]::-webkit-input-placeholder {
        visibility: hidden !important;
    }
</style>


@using SIMS.BL
@using (@Html.BeginForm("Index", "Attendance", FormMethod.Get))
{

    int userId = Users.RetrieveStaffIdByEmail(ViewContext.HttpContext.User.Identity.Name);
    Users user = Users.RetrieveById(userId);
    AccessMatrix accessMatrix = AccessMatrix.RetrieveByModuleName("Attendance");
    if (accessMatrix != null)
    {
AccessMatrixDetails accessMatrixDetails = AccessMatrixDetails.RetrieveAccess(accessMatrix.Id, user.Usertype);

        if (accessMatrixDetails != null)
        {

            <div class="card-body admin-outer-form">
                <div class="card-body admin-form">
                    <h3>Attendance List</h3>
                    <hr />
                    <div class="row">
                        <div class="col-12">&nbsp;</div>
                    </div>

                    <div class="row">
                        <div class="col-12">

                            <div class="card">

                                <div class="card-body">

                                    <div id="search">
                                        <div class="row">
                                            @if (accessMatrixDetails.IsSearch == true)
                                            {

                                                <div class="col-12 col-md-5 col-lg-3" style="float: right">
                                                    <div style="border:0.5px solid rgba(128, 128, 128, 0.59);border-radius:5px;padding:2px;">
                                                        @Html.TextBox("search", null, new { @class = "search", @placeholder = "Name", name = "search", style = "width:100%;border:none;outline:none;display:inline-flex" })
                                                    </div>
                                                </div>
                                                <div class="col-12 col-md-5 col-lg-4 d-flex btnReadAll">
                                                    <div class="mr-2" style="border:0.5px solid rgba(128, 128, 128, 0.59);border-radius:5px;padding:2px;display:inline-flex">
                                                        @Html.TextBox("startdate", null, new { @class = "search", @placeholder = "dd-mm-yyyy", id = "sdatepicker", name = "startdate", style = "width:105px;border:none;outline:none;" })
                                                        <span>&nbsp;-&nbsp;&nbsp;</span>
                                                        @Html.TextBox("enddate", null, new { @class = "search", @placeholder = "dd-mm-yyyy", id = "edatepicker", name = "enddate", style = "width:105px;border:none;outline:none;" })
                                                    </div>
                                                    <button type="submit" class="btn btn-block btn-outline-dark">
                                                        Search
                                                    </button>
                                                </div>

                                                <div class="col-6 col-md-6 col-lg-2 btnReadAll">
                                                    <button id="btnReadAll" class=" btn btn-block btn-dark">Show All</button>
                                                </div>
                                            }
                                            @if (accessMatrixDetails.IsExport == true)
                                            {
                                                <div class="col-6 col-md-6 col-lg-3 btnReadAll">
                                                    @Html.ActionLink("Export", "Excel", "Attendance", new
                                                    {
                                                        search = Request.QueryString["search"],
                                                        startdate = Request.QueryString["startdate"],
                                                        enddate = Request.QueryString["enddate"]
                                                    }, new { @class = "btn btn-dark btn-block " })
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">&nbsp;</div>
                                    </div>
                                    <!-- table-striped -->
                                    <table class="table table-responsive-lg  table-sm w3-table w3-striped w3-border" id="attendanceDataTable">
                                        <thead>
                                            <tr>
                                                <th class="d-none">
                                                    @Html.DisplayNameFor(model => model.First().Id)
                                                </th>
                                                <th>
                                                    @Html.DisplayNameFor(model => model.First().Date)
                                                </th>
                                                <th>
                                                    @Html.DisplayNameFor(model => model.First().Staffid)
                                                </th>

                                                <th>
                                                    @Html.DisplayNameFor(model => model.First().Department)
                                                </th>
                                                <th>
                                                    IN Time
                                                </th>
                                                <th>
                                                    OUT Time
                                                </th>
                                                <th class="d-none">
                                                    Default  IN Time
                                                </th>
                                                <th class="d-none">
                                                    Default OUT Time
                                                </th>

                                                <th>
                                                    Attendance
                                                <th>
                                                    @Html.DisplayNameFor(model => model.First().Reason)
                                                </th>
                                                @if (accessMatrixDetails.IsEdit == true)
                                                {
                                                    <th data-field="Edit" data-tableexport-display="none"></th>
                                                }

                                            </tr>
                                        </thead>

                                        @if (Model.Count() == 0)
                                        {
                                            <tr>
                                                <td colspan="9">No rows matching search criteria </td>
                                            </tr>
                                        }
                                        else
                                        {


                                            foreach (var item in Model)
                                            {
                                                <tr>
                                                    <td class="ID d-none">
                                                        @Html.DisplayFor(modelItem => item.Id)
                                                    </td>
                                                    <td>
                                                        <span hidden> @Html.ValueFor(modelItem => item.Date, "{0:MM-dd-yyyy}")</span>
                                                        @Html.DisplayFor(modelItem => item.Date)
                                                    </td>
                                                    <td class="Name">
                                                        @Html.DisplayFor(modelItem => item.StaffName)
                                                    </td>
                                                    <td class="Department">
                                                        @Html.DisplayFor(modelItem => item.Department)
                                                    </td>
                                                    <td class="Enteringtime">
                                                        @Html.DisplayFor(modelItem => item.Enteringtime)
                                                    </td>
                                                    <td class="Leavingtime">
                                                        @Html.DisplayFor(modelItem => item.Leavingtime)
                                                    </td>
                                                    <td class="InTime d-none">
                                                        @Html.ValueFor(modelItem => item.InTime, "{0:HH:mm:ss }")
                                                    </td>
                                                    <td class="OutTime d-none">
                                                        @Html.ValueFor(modelItem => item.OutTime, "{0:HH:mm:ss }")
                                                    </td>
                                                    <td class="Status">
                                                        @Html.DisplayFor(modelItem => item.Status)
                                                    </td>
                                                    <td class="Reason">
                                                        @if (item.Reason == "")
                                                        {
                                                            <label>----</label>
                                                        }
                                                        else
                                                        {
                                                            @Html.DisplayFor(modelItem => item.Reason)
                                                        }
                                                    </td>
                                                    <td data-field="Edit" data-tableexport-display="none">
                                                        @if (accessMatrixDetails.IsEdit == true)
                                                        {

                                                            <button type="button" class="GetId btn btn-sm btn-dark btn-block">Edit</button>

                                                        }
                                                    </td>

                                                </tr>
                                            }
                                        }

                                    </table>

                                </div>

                                <div class="card-footer text-muted">
                                    @Html.PagedListPager(Model, pageIndex => Url.Action("Index", new
                               {
                                   pageIndex,
                                   search = Request.QueryString["search"],
                                   startdate = Request.QueryString["startdate"],
                                   enddate = Request.QueryString["enddate"]
                               }),
        new PagedListRenderOptions() { Display = PagedListDisplayMode.IfNeeded })
                                    @*@Html.Partial("_PagingFooter")*@
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
}

<!-- Modal -->

<div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="staticBackdropLabel">Attendance</h3>
                <label>Date :  <span class="date"></span></label>
            </div>
            <div class="cards" style="padding-left:12px;">
                <div class="row">
                    <div class="col-4">
                        <label>Employee Name </label>
                    </div>
                    <div class="col-7">
                        <label id="staffName"></label>
                    </div>
                </div>
                <br />


                <div class="row">
                    <div class="col-4">
                        <label>Department</label>
                    </div>
                    <div class="col-7">
                        <label id="department"></label>
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-4">
                        <label>Status</label>
                    </div>
                    <div class="col-6">
                        <select id="status" class="form-control">
                            <option>Select</option>
                            <option>Present</option>
                            <option>Absent</option>
                        </select>
                    </div>
                </div>

                <div class="timestamp">
                    <hr />
                    <div class="row">
                        <div class="col-4">
                            <label>IN Time</label>
                        </div>
                        <div class="col-4" style="padding-left:0">
                            <input id="enteringTime" name="enteringTime" type="time" style="border-radius:2px" />

                        </div>
                        <div class="col-3">
                            <small style="font-size:11px;color:green">Default In time</small>   <sapn id="intime" style="font-size:14px"></sapn>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-4">
                            <label>OUT Time</label>
                        </div>
                        <div class="col-4" style="padding-left:0">
                            <input type="time" id="leavingTime" required="" pattern="hh:mm:ss" style="border-radius:2px;" />
                        </div>
                        <div class="col-3">
                            <small style="font-size:11px;color:green">Default out time</small>  <sapn id="outtime" style="font-size:14px"></sapn>
                        </div>
                    </div>


                </div>
                <br />
                <div id="divreason" style="display:none">
                    <div class="row">
                        <div class="col-4">
                            <label>Reason</label>
                        </div>
                        <div class="col-6">
                            <select id="reason" class="form-control">
                                <option>Select</option>
                                <option>Health Issue</option>
                                <option>Family Function</option>
                                <option>Personal work</option>
                            </select>
                        </div>
                    </div>
                </div>
                <br />

            </div><br />
            <div class="row">
                <div class="col-2 col-md-3"></div>
                <div class="col-8 col-md-6">
                    <button type="submit" class="btn btn-block btn-dark" id="submit">Save</button><br />
                </div>
                <div class="col-2 col-md-3"></div>
            </div>

            <div class="modal-footer">
                <span id="errormsg" style="color:red"></span>
                <span id="successmsg" style="color:green"></span>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
@section Scripts {

    <script src="~/Scripts/Admin/AttendanceScript.js"></script>
    <script>
        $(document).ready(function () {
            $('#sdatepicker').attr("readonly", "readonly");
            $('#edatepicker').attr("readonly", "readonly");

        })
    </script>
    <script>

        $('#sdatepicker').datepicker({
            dateFormat: 'dd-mm-yy',
        });
        $('#edatepicker').datepicker({
            dateFormat: 'dd-mm-yy',
        });

        $('#attendanceDataTable').dataTable({
            paging: false,
            "aaSorting": [[1, "desc"]]
        });
    </script>
    <script>

        $(document).ready(function () {
            $(".btnExport").hide();

        });
        function btnExportFullHide() {
            var chkFull = document.getElementById("chkFull").checked;
            if (chkFull == false) {
                $("#btnExportFull").hide();
                $(".btnExport").show();
            } else {
                $("#btnExportFull").show();
                $(".btnExport").hide();

            }
        }
        function exportToExcel(elem) {
            var table = document.getElementById("dataTable");
            var html = table.outerHTML;
            var url = 'data:application/vnd.ms-excel,' + escape(html); // Set your html table into url
            elem.setAttribute("href", url);
            elem.setAttribute("download", "Attendence.xls"); // Choose the file name
            return false;
        }

    </script>
}




